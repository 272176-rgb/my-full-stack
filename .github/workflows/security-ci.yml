name: Security CI (SAST + SCA + DAST)

on:
  push:
    branches: [ master, main ]
  pull_request:
    types: [ opened, synchronize, reopened ]
  workflow_dispatch: {}

concurrency:
  group: security-ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  actions: read

env:
  FRONT_URL: http://localhost:5173
  API_OPENAPI_URL: http://localhost:8000/api/v1/openapi.json
  DOCKER_BUILDKIT: "1"

defaults:
  run:
    shell: bash

jobs:
  sast_sca:
    name: SAST + SCA
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Prepare reports dir
        run: mkdir -p reports/sast reports/sca

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            frontend/package-lock.json
            frontend/package.json

      # -------- SAST: Semgrep --------
      - name: Semgrep (SAST)
        continue-on-error: true
        uses: returntocorp/semgrep-action@v1
        with:
          config: |
            p/owasp-top-ten
            p/ci
          generateSarif: "1"

      - name: Upload Semgrep SARIF to Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif

      - name: Collect Semgrep report
        if: always()
        run: |
          cp -f semgrep.sarif reports/sast/semgrep.sarif 2>/dev/null || true

      # -------- SAST: Bandit --------
      - name: Install Bandit
        continue-on-error: true
        run: pipx install bandit || pip install bandit

      - name: Run Bandit (backend)
        continue-on-error: true
        run: bandit -r backend -ll -iii -f json -o bandit.json

      - name: Collect Bandit report
        if: always()
        run: |
          cp -f bandit.json reports/sast/bandit.json 2>/dev/null || true

      # -------- SCA: Trivy (repo) -> SARIF --------
      - name: Trivy FS (SCA + misconfig + secrets)
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: .
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          format: sarif
          output: trivy-repo.sarif

      - name: Upload Trivy SARIF to Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-repo.sarif

      - name: Collect Trivy SARIF
        if: always()
        run: |
          cp -f trivy-repo.sarif reports/sca/trivy-repo.sarif 2>/dev/null || true

      # -------- SBOM: Trivy (CycloneDX) --------
      - name: Trivy SBOM (CycloneDX)
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: .
          args: --format cyclonedx --output sbom.cdx.json

      - name: Collect SBOM
        if: always()
        run: |
          cp -f sbom.cdx.json reports/sca/sbom.cyclonedx.json 2>/dev/null || true

      # -------- SCA: Python (pip-audit) --------
      - name: Install pip-audit
        continue-on-error: true
        run: pipx install pip-audit || pip install pip-audit

      - name: pip-audit (backend)
        continue-on-error: true
        run: |
          if [ -f backend/requirements.txt ]; then
            pip-audit -r backend/requirements.txt -f json -o pip-audit.json
          else
            echo '{}' > pip-audit.json
          fi

      - name: Collect pip-audit report
        if: always()
        run: |
          cp -f pip-audit.json reports/sca/pip-audit.json 2>/dev/null || true

      # -------- Frontend: lint + npm audit --------
      - name: Frontend install
        if: hashFiles('frontend/package.json') != ''
        continue-on-error: true
        working-directory: frontend
        run: npm ci

      - name: Frontend lint
        if: hashFiles('frontend/package.json') != ''
        continue-on-error: true
        working-directory: frontend
        run: npm run lint

      - name: npm audit (high+)
        if: hashFiles('frontend/package.json') != ''
        continue-on-error: true
        working-directory: frontend
        run: npm audit --audit-level=high --json > ../npm-audit.json

      - name: Collect npm-audit
        if: always() && hashFiles('frontend/package.json') != ''
        run: |
          cp -f npm-audit.json reports/sca/npm-audit.json 2>/dev/null || true

      # ---- Upload ONE artifact with everything from this job ----
      - name: Upload consolidated reports (SAST/SCA)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/**
          if-no-files-found: ignore
          retention-days: 14

  build_and_dast:
    name: DAST (ZAP) on docker-compose
    runs-on: ubuntu-latest
    needs: [sast_sca]
    if: always()
    timeout-minutes: 40
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Prepare reports dir
        run: mkdir -p reports/dast

      # Minimalny .env tylko do CI (podmień, jeśli masz sekrety w Actions)
      - name: Create .env for CI
        continue-on-error: true
        run: |
          cat > .env <<'EOF'
          DOMAIN=localhost
          FRONTEND_HOST=http://localhost:5173
          ENVIRONMENT=local
          SECRET_KEY=dev-secret
          FIRST_SUPERUSER=admin@example.com
          FIRST_SUPERUSER_PASSWORD=StrongPassw0rd!
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=changethis
          POSTGRES_DB=app
          POSTGRES_PORT=5432
          SMTP_HOST=
          SMTP_USER=
          SMTP_PASSWORD=
          EMAILS_FROM_EMAIL=info@example.com
          SENTRY_DSN=
          EOF

      - name: Build services
        continue-on-error: true
        run: docker compose build

      - name: Up db
        continue-on-error: true
        run: docker compose up -d --wait db

      - name: Up backend
        continue-on-error: true
        run: docker compose up -d --wait backend

      - name: Up frontend
        continue-on-error: true
        run: docker compose up -d --wait frontend

      - name: Wait for backend health
        continue-on-error: true
        run: |
          for i in {1..30}; do
            curl -fsS http://localhost:8000/api/v1/utils/health-check/ && exit 0
            sleep 3
          done
          echo "Backend not healthy"

      - name: Probe frontend
        continue-on-error: true
        run: |
          for i in {1..30}; do
            curl -fsS ${{ env.FRONT_URL }} && exit 0
            sleep 3
          done
          echo "Frontend not responding"

      - name: ZAP Baseline (frontend)
        continue-on-error: true
        run: |
          docker run --rm -t owasp/zap2docker-stable zap-baseline.py \
            -t "${{ env.FRONT_URL }}" \
            -r zap-frontend.html

      - name: ZAP API Scan (backend OpenAPI)
        continue-on-error: true
        run: |
          docker run --rm -t -u zap -v "$PWD:/zap/wrk" owasp/zap2docker-stable zap-api-scan.py \
            -t "${{ env.API_OPENAPI_URL }}" \
            -f openapi \
            -r zap-api.html

      - name: Collect ZAP reports
        if: always()
        run: |
          cp -f zap-frontend.html reports/dast/zap-frontend.html 2>/dev/null || true
          cp -f zap-api.html reports/dast/zap-api.html 2>/dev/null || true

      # ---- Upload to the SAME artifact name (will merge) ----
      - name: Upload consolidated reports (DAST)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports        # ten sam artefakt co w jobie SAST/SCA
          path: reports/**
          if-no-files-found: ignore
          retention-days: 14

      - name: Teardown
        if: always()
        run: docker compose down -v --remove-orphans
